# 勉強会
勉強会に参加した際のメモをまとめる。

## 【ElasticSearch】サポーターズ

### まとめ
- SQL,grepと、ElasticSearchの違い
- 形態素解析とn-gram
- 検索の設計と実装
- index構築について（負荷分散、非同期処理）
- 検索精度向上のための取り組み（適合率と再現率のトレードオフ）
- 検索改善プロセス（プロトタイプを作成して小さく始めて効果検証）
- アナログタイプクエリの改善

### SQL/grep vs ElasticSearch
SQL LIKE検索(grep)
```
・文書の前処理をしない。
・文字列や正規表現が含まれるか。
・文書量が多いと時間がかかる。
```

ElasticSearch
```
・文書を前処理し、indexを作成する
・索引を作る手間がかかる
・文書量に関わらず高速に
```

### 形態素解析とn-gram
どうやって単語に分割するかの分け方。  

形態素解析は分構造を解析して、単語で区切る  
```
（例）東京都 / の / 宿
```

n-gramは指定の語数で区切る。  
```
（2-gramの場合）東京 / 京都 / 都の / の宿
```

=> n-gramの場合、京都という関係のないワードがヒットしてしまう。ノイズが増える。

### 適合率、再現率
検索精度を計る一つの指標になりうる。  
```
適合率・・・どれだけ正解が含まれるか。
再現率・・・正解のうち、どの程度が検索にヒットするか。
```

適合率と再現率は反比例するため、トレードオフ。調和平均を取った値をF値とし、性能を表すことがあるそう。  
```
F値 = （2×適合率×再現率）/（適合率＋再現率）
```

下記リンクがよくまとめられていた。  
[検索結果の「再現率」と「適合率」](http://zellij.hatenablog.com/entry/20120214/p1)

### 辞書
kuromoji辞書には載っていない単語が存在するため、辞書自体をメンテする必要がある。  
また、その際、バッグとバックのようにsynonym（同意語）の辞書も作る。  

フリルでは、辞書や検索クエリのランキングを確認するための管理画面を作成して運用しているそう。   

### 所感
正直、チューニングについては既に知っていることばかりだったが、改善をするためのプロセスが印象的だった。検索クエリを保存しそれを自動でDBに保存してCMS上でその傾向を分析してチューニングを行うという...地道な作業だなーと思った。  
検索精度向上をしていくうえで、何を目的とするのかを決めるのが、ある意味一番肝心だと感じた。すべてを望んだ結果にすることは不可能という前提に立った上で、最終的に、定めた目的にいかに近づくかの「改善のプロセスの構築」が必要。  
適合率と再現率のトレードオフについては、サービスが扱う商品（あるいは記事）数や、利用者のニーズ、検索クエリから論理的に考える必要があると感じた。  

とはいえ、フリルだと専任で2人 * 半年でやっていて、人的コストを割ける状態であったため成立したとも言えるし、スタートアップが限りある時間の中で割けるパワーを考慮するのも重要。  

### 公式ドキュメント
[Elasticsearch Reference](https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html)

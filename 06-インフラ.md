# インフラ

## ブラウザでのリクエストからレスポンスまでの経路で、ソフトウェアエンジニアが意識しておいた方が良いことをまとめ

### プロトコル
通信動作のルールを定めたもの  
```
http : Webサーバーにアクセス
ftp : ファイルをダウンロードしたりアップロードする（FTPサーバーにアクセス）
file : ファイルからデータを読み込む
mailto : メールを送信する
news : ニュース・グループの記事を読む
```

### URLの解読
```
「http:」 + 「//」 + 「Webサーバー名」 + 「/」 + 「ディレクトリ名」 + 「/」 ・・・ + 「ファイル名」
```

例）
http://bookhub.jp/sample/index.html

「bookhub.jp」という名前のWebサーバー上にある「/sample/index.html」というパス名のファイルにアクセスするという意味。

### HTTP
リクエストメッセージにはURIとメソッドが含まれる。何を（＝URI）どうするか（=メソッド）に相当する。  

HTTPの主要なメソッド
```
GET : URIで指定した情報を取り出す。
POST : クライアントからサーバにデータを送信する。（フォーム入力）
PUT : URLで指定したサーバー上のファイルを置き換える。
DELETE : URIで指定したサーバー上のファイルを削除する。
```
レスポンス・メッセージにはステータス・コード（200, 404, 500など）とレスポンス・フレーズが含まれる。

### IPアドレス
URLにサーバー名の代わりにIPアドレスを書いても正しく動くが、DNS(Domain Name System)を介してサーバー名からIPアドレスを効率良く対応づけることができる。
DNSクライアントに相当するものをDNSリゾルバ（リゾルバ）といい、DNSの仕組みを使用してIPアドレスを調べることを名前解決（ネーム・リゾルーション）と呼ぶ。リゾルバの実体は、Socketライブラリのプログラム。
＊ Socketライブラリはネットワークの機能を呼び出すためのプログラム集

DNSサーバーは階層化されている。
comやjpをトップレベルドメインと呼び、さらにその上位をルートドメインと呼ぶ。
bookhub.jpの場合、下記のような階層になっていることになる。

1. ルートドメイン
2. jp（トップレベルドメイン）
3. bookhub（この名前のIPアドレスを名前解決する）

### データの送受信
送受信動作を行う前に送受信する両者の間をパイプでつなぐ動作が必要。パイプの両端をソケットと呼ぶ。

1. ソケットを作る（ディスクリプタをメモリーに記録）
2. サーバー側のソケットにパイプをつなぐ（connect）。ポート番号によりどのソケットと接続するのか判別。
3. データを送受信する（write/read）
4. パイプを外してソケットを抹消する（close）

### TCP/IPソフトの階層構造
OSに組み込まれたネットワーク制御用ソフトウェア（=プロトコル・スタック）とネットワーク用のハードウェア（LANアダプタ）が、ブラウザから受け取ったメッセージをサーバーに送り出す。

上から下に処理を依頼する。  

1. アプリケーション（ネットワーク・アプリケーション）
  - Socketライブラリ（リゾルバ）
2. OS（プロトコル・スタック）
  - TCP（コネクションを使う）、UDP（コネクションを使わない）、IP（パケットを運ぶ、経路を決める。ICMP、ARP）
3. ドライバ・ソフト
  - LANドライバ（LANアダプタを制御する）
4. ハードウェア
  - LANアダプタ

### ファイアーウォール
```
ファイアウォール・・・特定のサーバー上で動く特定のアプリケーションにアクセスするパケットだけを通し、それ以外のパケットを遮断する役割を持っている。
```

アプリケーションを限定するのには、TCPヘッダーやUDPヘッダーに記載されているポート番号を条件に加える。Webサーバーからインターネット側へのアクセスをコントロールするのには、TCPヘッダーにあるコントロールビットを参照する。

### サーバーの負荷分散のための仕組み
一台のサーバーで処理が追いつかない場合、複数のサーバーを使用してサーバー一台あたりの処理量を減らす。（＝分散処理）  
それには、クライアントが送ってくるリクエストをWebサーバーに振り分ける仕組みが必要。  
一番簡単なのは、DNSサーバーに同じ名前でWebサーバーを複数登録しておく方法。
```
bookhub.jpに対して、IPアドレスを複数登録しておく。アクセスがくると、そのIPアドレスを順番に返すようにする。（＝ラウンドロビン）
```

ただし、この方法だと下記の場合に問題になる。  
- 登録したWebサーバーのどれかが故障した場合（DNSサーバーはWebサーバーが正常に動作しているかどうかまでは確認しないため）
- CGIアプリケーションでページを作成する場合に、複数ページにまたがる処理  

これらの問題を解決したのが、負荷分散装置（ロードバランサー）である。  
負荷分散装置のIPアドレスをWebサーバーの代わりにDNSサーバーに登録しておく。

### キャッシュサーバー
Webサーバーの台数を増やす以外にも負荷分散する方法はある。それは、役割に応じてサーバーを分ける方法である。（Webサーバー、データベースサーバー、キャッシュサーバー）  

キャッシュサーバーは、プロキシという仕組みを使って、データをキャッシュするサーバーである。  
プロキシは、Webサーバーとクライアントの間に入って、Webサーバーへのアクセス動作を仲介する役割を持ったもので、Webサーバーから受け取ったデータをディスクに保存しておき、そのデータをWebサーバーに代わってクライアントに送り返す機能（＝キャッシュ）を持っている。  
リクエストに対して、Webサーバーはキャッシュにデータがある場合、「コンテンツに変更がない」ということをキャッシュサーバーに返送する。  
それを受けてキャッシュサーバーは、キャッシュに蓄えられたコンテンツのデータをクライアント側に返すという仕組み。  

### コンテンツ配信サービス
コンテンツ配信サービスは、キャッシュサーバーを設置してそれをWebサーバー運営者に貸し出すというサービスを提供する事業者のことである。

### マルチタスク・マルチスレッド
サーバープログラムを接続を待ち受ける部分とクライアントとやりとりする部分の二つに分ける。  

1. サーバープログラム起動
2. 初期化動作
3. 接続を待ち受ける部分を実行（ソケットを作成）
4. 休止状態
5. クライアントが接続
6. 接続を受け付ける
7. クライアントとやりとりする部分を起動（接続済みのソケットを渡して動作を引き継ぐ）
8. クライアントとやりとり
9. 終了後、切断  

こうすることで、クライアントとやりとりする部分が一台のクライアントと一対一で対応することになる。サーバーOSはマルチタスク、マルチスレッドと呼ばれる機能によって多数のプログラムを同時並行して動かすことができるが、その性質を利用したプログラミングテクニックである。

### サーバー側のソケット
1. ソケットを作る
2. ソケットを接続待ち状態にする
3. 接続を受け付ける
4. データを送受信する
5. パイプを外してソケットを抹消する  

次々と新しいソケットを作ることによって、別のクライアントが接続してきた時に接続待ちのソケットがないという状況にならないようにする。なお、ポート番号のみではどのソケットか判別できなくなるため、下記の情報も使うことでソケットを特定する。  
- クライアント側のIPアドレス
- クライアント側のポート番号
- サーバー側のIPアドレス
- サーバー側のポート番号

### まとめ
パケットが通る道筋を下記にまとめる  

1. クライアント
  - ブラウザ
  - Socketライブラリ
  - プロトコルスタック（TCP・IP）
  - LANドライバ
  - LANアダプタ
2. クライアント側LAN
  - ツイストペア・ケーブル
  - リピータ・ハブ
  - スイッチング・ハブ
  - インターネット接続用ルーター
  - ADSLモデム
3. アクセス回線
  - DSLAM
  - BAS
  - トンネル
  - トンネリング用ルーター
4. プロバイダ（インターネット）
5. Webサーバー側LAN
  - ファイアウォール
  - キャッシュサーバー
6. Webサーバー
  - プロトコルスタック（IP・TCP）
  - Socketライブラリ
  - Webサーバー

### 参考書籍
[『ネットワークはなぜつながるのか　知っておきたいTCP/IP、LAN、光ファイバの基礎知識（第2版）』（戸根 勤 著 / 日経NETWORK 監修）](http://ec.nikkeibp.co.jp/item/books/P81510.html)


## 【AWS】ElasticIPが足りなくてパブリックIPが付与されない問題に対する対処法
### 原因
通常、EC2インスタンスを作った時にパブリックIPが付与されるはずだが、上限(2018年2月現在、上限は5つ)に達していた場合、付与されない。

### ElasticIPの上限数の追加申請
マネジメントコンソールにログインして、下記画面より上限数の追加申請が可能。  
[申請画面](http://aws.amazon.com/jp/contact-us/eip_limit_request/)
